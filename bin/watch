#!/bin/bash
#--------------------------------------------
# ğŸš€ Hyperf Watch Scripts
# ğŸ˜Š Make Coding More Happy
# ğŸ‘‰ ç›‘å¬æ–‡ä»¶å˜åŒ–è‡ªåŠ¨é‡å¯Hyperf
# Author: hanicc@qq.com
# Version: 20190730@beta6
# GitHub: https://github.com/ha-ni-cc/hyperf-watch
#--------------------------------------------

# ç›‘å¬ç›®å½•
WATCH_DIR="${PWD}"
# ç›‘å¬æ‰©å±•åï¼ˆå¤šä¸ªç”¨/åˆ†éš”ï¼‰
WATCH_EXT="php/env"
# è¿è¡Œå‘½ä»¤
RUN_CMD="php ${WATCH_DIR}/bin/hyperf.php start"
# æ—¥å¿—è·¯å¾„
WATCH_LOG="${WATCH_DIR}/runtime/logs/watch.log"
# fswatchè·¯å¾„
FS_WATCH="fswatch"

# å¸®åŠ©æŒ‡å—
if [[ $1 = "-h" || $1 = "help" ]];then
    echo -e "ğŸ“š Hyperf Watch Scripts å¸®åŠ©æŒ‡å—"
    echo -e "Usage:  watch [path] [-] [options] [args]"
    echo -e "\twatch : é»˜è®¤ç›‘å¬ç›®å½•è·¯å¾„ä¸º{${WATCH_DIR}}ä¸æ¸…é™¤ç›‘å¬æ—¥å¿—"
    echo -e "\twatch -c : é»˜è®¤ç›‘å¬ç›®å½•è·¯å¾„ä¸º{${WATCH_DIR}}å¹¶æ¸…é™¤ç›‘å¬æ—¥å¿—"
    echo -e "\twatch -e xxx : é»˜è®¤ç›‘å¬ç›®å½•è·¯å¾„ä¸º{${WATCH_DIR}}å¹¶è®¾ç½®ç›‘å¬æ‰©å±•åxxx"
    echo -e "\twatch -h : æŸ¥çœ‹å¸®åŠ©æŒ‡å—"
    echo -e "\twatch help: æŸ¥çœ‹å¸®åŠ©æŒ‡å—"
    echo -e "\twatch ./app : è®¾ç½®ç›‘å¬ç›®å½•è·¯å¾„ä¸º{./app}"
    echo -e "\twatch ./app -c : è®¾ç½®ç›‘å¬ç›®å½•è·¯å¾„ä¸º{./app}å¹¶æ¸…é™¤ç›‘å¬æ—¥å¿—"
    echo -e "\twatch ./app -e xxx -c: è®¾ç½®ç›‘å¬ç›®å½•è·¯å¾„ä¸º{./app}å¹¶è®¾ç½®ç›‘å¬æ‰©å±•åxxxå¹¶æ¸…é™¤ç›‘å¬æ—¥å¿—"
    exit 1
fi

# æ£€æŸ¥fswatchæ˜¯å¦å®‰è£…
command -v ${FS_WATCH} >/dev/null 2>&1 || { echo >&2 "[x] è¯·å…ˆå®‰è£…fswatch"; exit 1;}


# æ˜¯å¦è®¾ç½®ç›‘å¬ç›®å½•
if [[ $1 != "" && $1 != "-c" && $1 != "-e" && $1 != "-r" ]];then
    WATCH_DIR=$1
    if [[ ! -d ${WATCH_DIR} ]];then
        echo "[x] è¯·ç¡®è®¤ç›®å½•{$WATCH_DIR}å­˜åœ¨ä¸”æ‹¥æœ‰è®¿é—®æƒé™"
        exit 1
    fi
fi

# æ˜¯å¦è®¾ç½®ç›‘å¬æ‰©å±•å
if [[ $* =~ "-e" ]];then
    ARGS=${*##*-c}
    ARGS=${ARGS#*-e}
    WATCH_EXT=${ARGS// /}
    if [[ ${WATCH_EXT} = "" ]]; then
        echo "[x] è¯·è®¾ç½®ç›‘å¬æ‰©å±•åï¼Œå¤šä¸ªç”¨/åˆ†éš”"
        exit 1
    fi
fi

echo -e "ğŸµ Loading Hyperf Watch Scripts"
echo -e "ğŸ‘‰ Watching Dir @ {${WATCH_DIR}}"
echo -e "ğŸ‘‰ Watching File Extension @ {${WATCH_EXT}}"
echo -e "ğŸ‘‰ Watching Log File @ {${WATCH_LOG}}"
echo -e "ğŸ‘‰ Running Command {${RUN_CMD}}"

# æ˜¯å¦éœ€è¦æ¸…ç†ç›‘å¬æ—¥å¿—
if [[ $* =~ "-c" ]];then
    if [[ -f ${WATCH_LOG} ]];then
        rm -rf ${WATCH_LOG}
    fi
    echo -e "ğŸ‘‰ Clean Watch Log Success"
fi

# å¦‚æœå­˜åœ¨è¿è¡Œè¿›ç¨‹å…ˆæ€è¿›ç¨‹
PID=`ps -ef | grep "${RUN_CMD}" | grep -v grep | awk '{print $2}'`
if [[ ${PID} != "" ]];then
    kill -9 ${PID}
fi

START="ğŸš€ Start @ $(date "+%Y-%m-%d %H:%M:%S")"
echo -e ${START}
echo -e "\n ================================ \n ${START}\n ================================ \n" >> ${WATCH_LOG}

# åå°è¿è¡Œå¹¶å°†è¾“å‡ºä¿å­˜åˆ°ç›‘å¬æ—¥å¿—è·¯å¾„
nohup ${RUN_CMD} >> ${WATCH_LOG} 2>&1 &

# å¼€å§‹ç›‘å¬
${FS_WATCH} -Ee"\.json|\.lock|.idea|vendor|runtime" --event IsFile ${WATCH_DIR} | while read file
do
    # å¦‚æœåŒ¹é…ç›‘å¬æ‰©å±•å
    if [[ ${WATCH_EXT} =~ ${file##*.} ]];then
        # é‡å¯è¿›ç¨‹
        ps -ef | grep "${RUN_CMD}" | grep -v grep | awk '{print $2}' | xargs kill
        RESTART="ğŸ”„ Restart @ $(date "+%Y-%m-%d %H:%M:%S")"
        echo -e "\n ================================ \n ${RESTART}\n ğŸ‘‰ $file was modified.\n ================================ \n" >> ${WATCH_LOG}
        # nohup ${RUN_CMD} >> ${WATCH_LOG} 2>&1 &
        echo ${RESTART}
    fi
done

# é€€å‡ºæ€è¿›ç¨‹
ps -ef | grep "${RUN_CMD}" | grep -v grep | awk '{print $2}' | xargs kill
# æŒ‚è½½ç›‘å¬æ—¥å¿—
cat ${WATCH_LOG}
